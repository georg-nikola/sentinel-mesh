name: Auto-Rebase Open PRs

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  rebase-prs:
    name: Rebase Open Pull Requests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Fetch all branches
        run: |
          git fetch --all
          git pull origin main

      - name: Get open PRs
        id: prs
        run: |
          # Get all open PRs targeting main branch
          PRS=$(gh pr list --state open --base main --json number,headRefName,isCrossRepository --limit 100)
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "Found $(echo "$PRS" | jq '. | length') open PRs"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebase PRs
        run: |
          PRS='${{ steps.prs.outputs.prs }}'

          if [ "$(echo "$PRS" | jq '. | length')" -eq 0 ]; then
            echo "No open PRs to rebase"
            exit 0
          fi

          echo "$PRS" | jq -r '.[] | @json' | while IFS= read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            IS_FORK=$(echo "$pr" | jq -r '.isCrossRepository')

            # Skip PRs from forks (can't force push to fork branches)
            if [ "$IS_FORK" = "true" ]; then
              echo "âŠ˜ PR #$PR_NUMBER: Skipping (from fork)"
              continue
            fi

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Rebasing PR #$PR_NUMBER (branch: $BRANCH)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Fetch the PR branch
            git fetch origin "$BRANCH:$BRANCH" || {
              echo "âœ— Failed to fetch branch $BRANCH"
              continue
            }

            # Checkout the PR branch
            git checkout "$BRANCH" || {
              echo "âœ— Failed to checkout branch $BRANCH"
              continue
            }

            # Attempt rebase
            if git rebase origin/main; then
              echo "âœ“ Rebase successful"

              # Force push the rebased branch
              if git push --force-with-lease origin "$BRANCH"; then
                echo "âœ“ Force pushed rebased branch"

                # Close and reopen PR to trigger CI workflows
                # Note: Force-pushes with GITHUB_TOKEN don't trigger workflows due to GitHub security
                echo "ðŸ”„ Closing and reopening PR to trigger CI workflows..."
                gh pr close "$PR_NUMBER" --comment "ðŸ”„ **Auto-rebase complete**: Rebased on latest \`main\`. Reopening to trigger CI workflows..." || echo "âš  Failed to close PR"
                sleep 2
                gh pr reopen "$PR_NUMBER" --comment "âœ… **CI workflows triggered**: All status checks will run on the rebased commit." || echo "âš  Failed to reopen PR"

                echo "âœ… PR #$PR_NUMBER rebased successfully and CI triggered"
              else
                echo "âœ— Failed to force push branch $BRANCH"
                git rebase --abort || true
              fi
            else
              echo "âœ— Rebase failed (conflicts)"
              git rebase --abort || true

              # Comment on PR about conflicts
              gh pr comment "$PR_NUMBER" --body "âš ï¸ **Auto-rebase failed**: This PR has conflicts with the latest \`main\` branch and needs manual resolution." || echo "âš  Failed to comment on PR"

              echo "âŒ PR #$PR_NUMBER has conflicts - manual intervention required"
            fi

            # Return to main branch
            git checkout main || true
          done

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Auto-rebase completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        if: always()
        run: |
          PRS='${{ steps.prs.outputs.prs }}'
          TOTAL=$(echo "$PRS" | jq '. | length')
          FORKS=$(echo "$PRS" | jq '[.[] | select(.isCrossRepository == true)] | length')
          REBASEABLE=$((TOTAL - FORKS))

          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # ðŸ”„ Auto-Rebase Summary

          - **Total Open PRs**: $TOTAL
          - **PRs from Forks** (skipped): $FORKS
          - **PRs Attempted**: $REBASEABLE

          ## Notes

          - âœ… PRs without conflicts were rebased and force-pushed
          - ðŸ”„ Successfully rebased PRs are closed/reopened to trigger CI workflows
          - âš ï¸ PRs with conflicts were left unchanged (comments added)
          - âŠ˜ PRs from forks were skipped (can't force-push to fork branches)

          ## Why Close/Reopen?

          Force-pushes with \`GITHUB_TOKEN\` don't trigger other workflows due to GitHub's
          security design (prevents recursive workflow runs). Closing and reopening the PR
          ensures all required CI checks run on the rebased commit.

          Check individual PR comments for detailed status.
          EOF
